---
title: "Introduction"
author: "Marcus Beck"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Introduction}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  message = F, warning = F, 
  fig.align = "center", 
  echo = T
)

library(dplyr)
library(wqtrends)
library(plotly)
library(english)
```

This package can be used to assess water quality trends for long-term monitoring data in estuaries using Generalized Additive Models and mixed-effects meta-analysis.

# Basic usage

The sample dataset `rawdat` is included in the package and is used for the examples below.  This dataset includes monthly time series data over ~30 years for nine stations in South Bay, San Francisco Estuary.  Data are available for `r english(length(unique(rawdat$param)))` water quality parameters.  All data are in long format with one observation per row.

The data are pre-processed to work with the GAM fitting functions included in this package.  The columns include date, station number, parameter name, and value for the date.  Additional date columns are included that describe the day of year (`doy`), date in decimal time (`cont_year`), year (`yr`), and month (`mo` as character label).  These are required for model fitting or use with the analysis/plotting functions.    

```{r}
head(rawdat)
```

One GAM model can be fit to the time series data. Each GAM fits additive smoothing functions to describe variation of the response variable (`value`) over time, where time is measured as an annual and seasonal effect.  The four models describe the time components differently and represent increasing levels of complexity to describe the response variable:

* `S`: value ~ s(year, k = *large*)

The `cont_year` vector is measured as a continuous numeric variable for the annual effect (e.g., January 1st, 2000 is 2000.0, July 1st, 2000 is 2000.5, etc.) and `doy` is the day of year as a numeric value from 1 to 366.  The function `s()` models `cont_year` as a smoothed, non-linear variable. The optimal amount of smoothing on `cont_year` is determined by cross-validation as implemented in the mgcv package and an upper theoretical upper limit on the number of knots for `k` should be large enough to allow sufficient flexibility in the smoothing term.  The upper limit of `k` was chosen as 12 times the number of years for the input data. If insufficient data are available to fit a model with the specified `k`, the number of knots is decreased until the data can be modelled, e.g., 11 times the number of years, 10 times the number of years, etc. 

The `anlz_gam()` function is used to fit the model.  First, the raw data are filtered to select only station 32 and the chlorophyll parameter.  The model is fit using a log-10 transformation of the response variable.  Available transformation options are log10 (`log10`) or identity (`ident`). 

```{r}
tomod <- rawdat %>%
 filter(station %in% 34) %>%
 filter(param %in% "chl")
mod <- anlz_gam(tomod, trans = "log10")
mod
```

All remaining functions use the model results to assess fit and plot results.

The fit can be assessed using `anlz_smooth()` and `anlz_fit()`, where the former assesses the individual smoother functions and the latter assesses overall fit. The `anlz_smooth()` results show the individual effects of the modelled components of each model as the effective degrees of freedom (`edf`), the reference degrees of freedom (`Ref.df`), the test statistic (`F`), and significance of the component (`p-value`).  The significance of the component is in part based on the difference between `edf` and `Ref.df`.  The `anlz_fit()` results show the overall summary of the model as Akaike Information Criterion (`AIC`), the generalized cross-validation score (`GCV`), and the `R2` values.  Lower values for `AIC` and `GCV` and higher values for `R2` indicate improved model fit.

```{r}
anlz_smooth(mod)
anlz_fit(mod)
```

The plotting functions show the results in different formats.  If appropriate for the response variable, the model predictions are back-transformed and the scales on each plot are shown in log10-scale to preserve the values of the results.

The `show_prddoy()` function shows estimated results by day of year with separate lines for each year.

```{r, fig.height = 5, fig.width = 6}
ylab <- "Chlorophyll-a"
show_prddoy(mod, ylab = ylab)
```

The `show_prdseries()` function shows predictions for the model across the entire time series.  Points are the observed data and the lines are the predicted.

```{r, fig.height = 4, fig.width = 6}
show_prdseries(mod, ylab = ylab)
```

The `show_prdseason()` function is similar except that the model predictions are grouped by month. This provides a visual depiction of seasonal trends over time.  The trend analysis functions below can be used to statistically test the seasonal changes.

```{r, fig.height = 4, fig.width = 6}
show_prdseason(mod, ylab = ylab)
```

Finally, the `show_prd3d()` function shows a three-dimensional fit of the estimated trends across year and day of year with the z-axis showing the estimates for the response variable. 

```{r}
show_prd3d(mod, ylab = ylab)
```

# Trend testing

Statistical tests for evaluating trends are available in this package. These methods are considered "secondary" or "tertiary" analyses that use results from a fitted GAM to evaluate trends or changes over time.  Each test includes a plotting method to view the results.

## Evalauting changes between time periods

The `anlz_perchg()` and `show_perchg()` functions can be used to compare annual averages between two time periods of interest.  The functions require base and test year inputs that are used for comparison.  More than one year can be entered for the the base and test years, e.g., `baseyr = c(1990, 1992, 1993)` vs. `testyr = c(2014, 2015, 2016)`.  

```{r}
anlz_perchg(mod, baseyr = 2006, testyr = 2017)
```

To plot the results for one GAM, use the `show_perchg()` function. The plot title summarizes the results. 

```{r, fig.height = 4, fig.width = 9}
show_perchg(mod, baseyr = 2006, testyr = 2017, ylab = "Chlorophyll-a (ug/L)")
```

## Evaluating seasonal changes over time 

The `anlz_avgseason()`, `anlz_mixmeta()`, and `show_avgseason()` functions evaluate seasonal averages between years, including an assessment of the trend for selected years using mixed meta-analysis modelling.  These functions require inputs for the seasonal ranges to evaluate (`doyend`, `doystr`) and years for assessing the trend in the seasonal averages (`yrstr`, `yrend`).  

The `anlz_avgseason()` estimates the seasonal averages (including standard error) for results from the GAM fit.

```{r}
avgseason <- anlz_avgseason(mod, doystr = 90, doyend = 180)
head(avgseason)
```

The `anlz_mixmeta()` function uses results from `anlz_avgseason()` to estimate the trend in the seasonal average over a selected year range. Here, we evaluate the seasonal trend from 2006 to 2017 for the seasonal estimate of the model results above.  

```{r}
anlz_mixmeta(avgseason, yrstr = 2006, yrend = 2017)
```

The `show_avgseason()` function plots the seasonal averages and trends over time. The `anlz_avgseason()` and `anlz_mixmeta()` functions are used internally to get the predictions.

```{r, fig.height = 4, fig.width = 9, echo = T}
show_avgseason(mod, doystr = 90, doyend = 180, yrstr = 2006, yrend = 2017, ylab = "Chlorophyll-a (ug/L)")
```

The seasonal estimates and mixed-effects meta-analysis regression can be used to estimate the rate of seasonal change across the time series.  For any given year and seasonal average, a trend can be estimated within a specific window (i.e., `yrstr` and `yrend` arguments in `show_avgseason()`).  This trend can be estimated for every year in the period of record to estimate the rate of change over time for the seasonal estimates.  

The `anlz_trndseason()` function estimates the rate of change and the `show_trndseason()` function plots the results. For both, all inputs required for the `anlz_avgseason()` function are required, in addition to the desired window width to evaluate for each year (`win`) and the justification for the window as `"left"`, `"right"`, or `"center"` from each year (`justify`).

```{r}
trndseason <- anlz_trndseason(mod, doystr = 90, doyend = 180, justify = 'left', win = 5)
head(trndseason)
```

The `show_trndseason()` function can be used to plot the results directly, one model at a time. 

```{r, fig.height = 5, fig.width = 9, echo = T}
show_trndseason(mod, doystr = 90, doyend = 180, justify = 'left', win = 5, ylab = 'Chl. change/yr')
```

