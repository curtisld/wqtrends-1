---
title: "Introduction"
author: "Marcus Beck"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Tidal Creek Assessment}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = F, warning = F, 
  fig.align = 'center'
)

library(dplyr)
library(wqtrends)
library(plotly)
```

This package can be used to assess water quality trends for long-term monitoring data in estuaries using Generalized Additive Models.  It builds extensively off of the [baytrends](https://cran.r-project.org/web/packages/baytrends/index.html) R package developed by the Chesapeake Bay Program.
  
# Analysis functions

* `anlz_avgseason()`: Extract period (seasonal) averages from fitted GAM
* `anlz_backtrans()`: Back-transform response variable after fitting GAM
* `anlz_fit()`: Return summary statistics for GAM fits
* `anlz_gam()`: Fit a generalized additive model to a water quality time series
* `anlz_mixmeta()`: Fit a mixed meta-analysis regression model of trends
* `anlz_perchg()`: Estimate percent change trends from GAM results for selected time periods
* `anlz_prd()`: Get predicted data from fitted GAMs across period of observation
* `anlz_prdday()`: Get predicted data from fitted GAMs across period of observation, every day
* `anlz_pvalformat()`: Format p-values for show functions
* `anlz_smooth()`: Return summary statistics for smoothers of GAMs
* `anlz_trans()`: Transform response variable prior to fitting GAM

# Show functions

* `show_avgseason()`: Plot period (seasonal) averages from fitted GAM
* `show_perchg()`: Plot percent change trends from GAM results for selected time periods
* `show_prd3d()`: Plot a 3-d surface of predictions
* `show_prddoy()`: Plot predictions for GAMs against day of year
* `show_prdseason()`: Plot predictions for GAMs over time, by season
* `show_prdseries()`: Plot predictions for GAMs over time series

# Basic usage

## Individual model

Start by fitting a GAM with the `anlz_gam()` function.  The sample dataset `rawdat` can be used for the example.  Here we fit the `gam2` model using a BoxCox power transformation of the response variable.  

```{r}
head(rawdat)

tomod <- rawdat %>%
 filter(station %in% 32) %>%
 filter(param %in% 'chl')
mod <- anlz_gam(tomod, mod = 'gam2', trans = 'boxcox')
mod
```

The power transformation estimate is attached to the model object and is used in later functions for back-transformation. 

```{r}
mod$trans
```

The fit can be assessed using `anlz_fit()` and `anlz_smooth()`, where the former assesses overall fit and the latter assesses the individual smoother functions.

```{r}
mod <- list(gam2 = mod)
anlz_fit(mods = mod)
anlz_smooth(mods = mod)
```

The plotting functions show the results in different formats.  The model predictions are back-transformed and the scales on each plot are show in log10-scale to preserve the values of the results.

```{r, fig.height = 5, fig.width = 6}
ylab <- 'Chlorophyll-a'
show_prddoy(mods = mod, ylab = ylab)
```

```{r, fig.height = 4, fig.width = 6}
show_prdseries(mods = mod, ylab = ylab)
```

```{r, fig.height = 4, fig.width = 6}
show_prdseason(mods = mod, ylab = ylab)
```

```{r}
show_prd3d(mods = mod, ylab = ylab)
```

## Multiple models

The functions above also work with a list of different models. 

```{r}
trans <- 'boxcox'
mods <- list(
  gam0 = anlz_gam(tomod, mod = 'gam0', trans = trans),
  gam1 = anlz_gam(tomod, mod = 'gam1', trans = trans),
  gam2 = anlz_gam(tomod, mod = 'gam2', trans = trans),
  gam6 = anlz_gam(tomod, mod = 'gam6', trans = trans)
)
```

Compare fits of multiple models:

```{r}
anlz_fit(mods = mods)
anlz_smooth(mods = mods)
```

The plotting functions work the same, with separate facets for each model. The `show_prd3d()` function does not work with multiple models. 

```{r, fig.height = 4, fig.width = 10}
ylab <- 'Chlorophyll-a'
show_prddoy(mods = mods, ylab = ylab)
```

```{r, fig.height = 9, fig.width = 6}
show_prdseries(mods = mods, ylab = ylab)
```

```{r, fig.height = 9, fig.width = 6}
show_prdseason(mods = mods, ylab = ylab)
```

## Trend testing

Two types of statistical tests are available in this package.  Both are considered "secondary" analyses that use results from a fitted GAM to evaluate trends or changes over time.  Each test includes a plotting method to view the results.  As above, the functions work with multiple model inputs (i.e., a list of fitted GAMs for the same time series), whereas the plotting functions only plot one model at a time. 

The `anlz_perchg()` and `show_perchg()` functions can be used to compare annual averages between two time periods of interest.  The functions require base and test year inputs that are used for comparison.  More than one year can be entered for the the base and test years, e.g., `baseyr = c(1990, 1992, 1993)` vs. `testyr = c(2014, 2015, 2016)`.  

```{r}
# use fitted list of models
trans <- 'boxcox'
mods <- list(
  gam0 = anlz_gam(tomod, mod = 'gam0', trans = trans),
  gam1 = anlz_gam(tomod, mod = 'gam1', trans = trans),
  gam2 = anlz_gam(tomod, mod = 'gam2', trans = trans)
  )
anlz_perchg(mods = mods, baseyr = 2006, testyr = 2017)
```

To plot the results for one GAM, use the `show_perchg()` function. The plot title summarizes the results. 

```{r, fig.height = 4, fig.width = 9}
show_perchg(tomod, trans = 'boxcox', gami = 'gam2', baseyr = 2006, testyr = 2017, 
            ylab = 'Chlorophyll-a (ug/L)')
```

The `anlz_avgseason()`, `anlz_mixmeta()`, and `show_avgseason()` functions evaluate seasonal averages between years, including an assessment of the trend for selected years using mixed meta-analysis modelling.  These functions require inputs for the seasonal ranges to evaluate (`doyend`, `doystr`) and years for assessing the trend in the seasonal averages (`yrstr`, `yrend`).  

The `anlz_avgseason()` estimates the seasonal averages (including standard error) for results from the GAM fits.  Here, three models are evaluated. 

```{r}
trans <- 'boxcox'
mods <- list(
  gam0 = anlz_gam(tomod, mod = 'gam0', trans = trans),
  gam1 = anlz_gam(tomod, mod = 'gam1', trans = trans),
  gam2 = anlz_gam(tomod, mod = 'gam2', trans = trans)
  )
avgseason <- anlz_avgseason(mods = mods, doystr = 90, doyend = 180)
head(avgseason)
```

The `anlz_mixmeta()` function uses results from `anlz_avgseason()` to estimate the trend in the seasonal average over a selected year range. Here, we evaluate the seasonal trend from 2006 to 2017 for the seasonal estimate of the three model results above.  

```{r}
anlz_mixmeta(avgseason, yrstr = 2006, yrend = 2017)
```

The `show_avgseason()` function plots the seasonal averages and trends over time for one GAM. The `anlz_avgseason()` and `anlz_mixmeta()` functions are used internally to get the predictions.

```{r, fig.height = 4, fig.width = 9}
trans <- 'boxcox'
mods <- list(
  gam2 = anlz_gam(tomod, mod = 'gam2', trans = trans)
  )
show_avgseason(mods = mods, trans = 'boxcox', doystr = 90, doyend = 180, yrstr = 2006, yrend = 2017, 
               ylab = 'Chlorophyll-a (ug/L)', gami = 'gam2')
```

